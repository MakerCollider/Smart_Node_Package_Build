//
//  screen.cpp
//  motor_node
//
//  Created by yy on 15/6/9.
//  Copyright (c) 2015 yy. All rights reserved.
//

#include <iostream>
#include "stdlib.h"
#include "mraa.hpp"
#include "stdio.h"
#include "uv.h"

#include "edi_robot.h"
#include "LED_16_16.h"

using namespace std;

void *screenLoop = NULL;
uv_timer_t screenTimer;
int face = -1;
LED_16_16 *led_screen;
screenConfig ScreenConfig;

unsigned char tab[][32]={
    0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x7E,0x7E,0x40,0x40,0x00,0x00,
    0x00,0x00,0x00,0x00,0x00,0x00,0xF0,0x0F,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
    
    0x00,0x00,0x00,0x00,0x00,0x00,0x18,0x18,0x24,0x24,0x42,0x42,0x00,0x00,0x00,0x00,
    0x00,0x00,0x00,0x00,0x00,0x00,0x10,0x08,0xE0,0x07,0x00,0x00,0x00,0x00,0x00,0x00,
    
    0xFF,0xFF,0x01,0x80,0x01,0x80,0x01,0x80,0x01,0x80,0x7D,0xBE,0x41,0xA0,0x01,0x80,
    0x01,0x80,0x01,0x80,0x01,0x80,0xE1,0x8F,0x01,0x80,0x01,0x80,0x01,0x80,0xFF,0xFF,
    
    0xFF,0xFF,0x01,0x80,0x01,0x80,0x19,0x98,0x25,0xA4,0x43,0xC2,0x01,0x80,0x01,0x80,
    0x01,0x80,0x01,0x80,0x01,0x80,0x11,0x88,0xE1,0x87,0x01,0x80,0x01,0x80,0xFF,0xFF,
    
};

void run_screen_uv_timer(uv_timer_t *req)
{
    if(face >= 0 && face <=3)
    {
        led_screen->flash(tab, face);
    }
    else if(face == -1)
    {
       led_screen->blank();
    }
    else
    {
        led_screen->blank();
        printf("Please input number under 3(include 3)\n");
    }
}

int screenInit(screenConfig config)
{
    ScreenConfig = config;
    
    printf("initialized screen\n");
    
    led_screen = new LED_16_16(0, 18, 17, 16, 15, 14);

    // Initialize uv loop and timer
    uv_timer_stop(&screenTimer);
    
    if(screenLoop == NULL) {
        screenLoop = uv_default_loop();
    }
    uv_timer_init((uv_loop_t*)screenLoop, &screenTimer);
    screenTimer.data = NULL;
    printf("Down!");    
    uv_timer_start(&screenTimer, run_screen_uv_timer, 0, config.refreshFreq);
    
    return ERR_NONE;
}

int screenRelease()
{
    printf("turn off screen\n");
    delete led_screen;
    uv_timer_stop(&screenTimer);
    
    return ERR_NONE;
}

int screenOnData(int faceId)
{
    face = faceId;
    return ERR_NONE;
}

